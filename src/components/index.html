<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reporte Semanal</title>

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Configuración de Tailwind (Opcional) -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'inter': ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>

  <!-- Vue 3 via CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- Chart.js via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Estilos BACKGROUND-->
  <style type="text/tailwindcss">
    :root {
      --primary-bg: #061137;
      --card-bg: #0A1F4D;
      --accent-blue: #429AEE;
      --border-color: #1E3A7B;
    }

    @layer base {
      html, body {
        @apply bg-[#061137] text-white font-inter leading-tight;
      }
    }

    @layer components {
      .metric-card {
        @apply relative rounded-xl p-4 border-l-4 border-l-[#429AEE]
               bg-[#0A1F4D]/90 shadow-md
               transition-all duration-300 hover:shadow-xl;
      }

      .gradient-text {
        @apply bg-gradient-to-r from-white via-[#6FB6F2] to-[#429AEE] bg-clip-text text-transparent;
      }

      .section-title {
        @apply text-xl font-semibold gradient-text mb-3;
      }

      .section-description {
        @apply text-sm text-gray-200;
      }
    }

    /* Estilos base para tablas */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1rem;
    }
    th, td {
      @apply border border-[#1E3A7B]/40 p-2 text-sm;
    }
    th {
      @apply bg-[#1E3A7B]/40 font-semibold text-white;
    }

    /* Contenedor de gráficos */
    .chart-container {
      @apply w-full h-48 relative mt-2;
    }
    canvas {
      @apply w-full h-full;
    }
  </style>
</head>
<body>
  <div id="app" class="max-w-6xl mx-auto px-3 py-5">
    <!-- Título de la página -->
    <h1 class="text-3xl font-bold gradient-text mb-4">
      Reporte Semanal
    </h1>

    <!-- Diseño en cuadrícula para las secciones -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">

      <!-- Temas Relevantes -->
      <div class="metric-card">
        <h2 class="section-title">Temas Relevantes</h2>
        <p class="section-description">
          Identificación de los temas más discutidos en correos a lo largo de la semana.
        </p>
        <table>
          <tr>
            <th>Tema</th>
            <th>Menciones</th>
          </tr>
          <tr v-for="(topic, idx) in hotTopics" :key="'topic-'+idx">
            <td>{{ topic.Topic }}</td>
            <td>{{ topic.Mentions }}</td>
          </tr>
        </table>
      </div>

      <!-- Distribución de Correos -->
      <div class="metric-card">
        <h2 class="section-title">Distribución de Correos</h2>
        <p class="section-description">
          Análisis de la distribución de correos por tipo y cuenta.
        </p>
        
        <!-- Distribución Global -->
        <h3 class="text-lg font-medium text-[#6FB6F2] mt-4 mb-2">
          Distribución Global
        </h3>
        <div class="chart-container h-48">
          <canvas id="servicingDistributionUserDonut"></canvas>
        </div>

        <!-- Distribución por Cuenta -->
        <h3 class="text-lg font-medium text-[#6FB6F2] mt-6 mb-2">
          Distribución por Cuenta
        </h3>
        <div class="chart-container h-48">
          <canvas id="servicingDistributionAccountBar"></canvas>
        </div>
      </div>

      <!-- Tiempo de Gestión (por Integrante) -->
      <div class="metric-card xl:col-span-2">
        <h2 class="section-title">Tiempo de Gestión (por Integrante)</h2>
        <p class="section-description">
          Horas promedio dedicadas a la gestión de cuentas y servicios, por cada miembro del equipo.
        </p>
        <div class="chart-container">
          <canvas id="handlingTimeTeamChart"></canvas>
        </div>
      </div>

      <!-- Tiempo de Gestión (por Cuenta) -->
      <div class="metric-card">
        <h2 class="section-title">Tiempo de Gestión (por Cuenta)</h2>
        <p class="section-description">
          Tiempo promedio de resolución por cada cuenta gestionada.
        </p>
        <div class="chart-container">
          <canvas id="handlingTimeAccountChart"></canvas>
        </div>
      </div>

      <!-- Volumen de Actividad por Empresa -->
      <div class="metric-card">
        <h2 class="section-title">Volumen de Actividad por Empresa</h2>
        <p class="section-description">
          Gráfico de pastel que muestra la distribución del volumen de actividad (por cuenta).
        </p>
        <div class="chart-container">
          <canvas id="activityVolumeChart"></canvas>
        </div>
      </div>

      <!-- Cuentas Sin Propuestas -->
      <div class="metric-card">
        <h2 class="section-title">Cuentas Sin Propuestas</h2>
        <p class="section-description">
          Listado de cuentas asignadas al equipo que aún no han recibido ninguna propuesta.
        </p>
        <table>
          <tr>
            <th>Cuenta</th>
            <th>Estado</th>
          </tr>
          <tr v-for="(company, idx) in accountsWithoutProposals" :key="'noProposal-'+idx">
            <td>{{ company.Name }}</td>
            <td>{{ company.Status }}</td>
          </tr>
        </table>
      </div>

      <!-- Empresas Sin Asignar -->
      <div class="metric-card">
        <h2 class="section-title">Empresas Sin Asignar</h2>
        <p class="section-description">
          Análisis de la actividad en empresas que no están asignadas a ningún miembro del equipo.
        </p>
        <table>
          <tr>
            <th>Empresa</th>
            <th>Detalles</th>
          </tr>
          <tr v-for="(unassigned, idx) in unassignedCompanies" :key="'unassigned-'+idx">
            <td>{{ unassigned.Name }}</td>
            <td>{{ unassigned.Comments }}</td>
          </tr>
        </table>
      </div>

      <!-- Actividad del Equipo (Reuniones + Correos) -->
      <div class="metric-card xl:col-span-2">
        <h2 class="section-title">Actividad del Equipo</h2>
        <p class="section-description">
          Reuniones y Correos: Gráfico de barras que muestra el número de interacciones por integrante.
        </p>
        <div class="chart-container">
          <canvas id="teamActivityChart"></canvas>
        </div>
      </div>

      <!-- Contestabilidad de Correos (Donut) -->
      <div class="metric-card">
        <h2 class="section-title">Contestabilidad de Correos</h2>
        <p class="section-description">
          Proporción de correos que han recibido respuesta vs. los que siguen sin contestar.
        </p>
        <div class="chart-container">
          <canvas id="emailResponseChart"></canvas>
        </div>
      </div>

      <!-- Emails Pendientes de Respuesta -->
      <div class="metric-card">
        <h2 class="section-title">Emails Pendientes de Respuesta</h2>
        <p class="section-description">
          Listado de correos que llevan días en espera de respuesta.
        </p>
        <table>
          <tr>
            <th>Asunto</th>
            <th>Remitente</th>
            <th>Días en Espera</th>
          </tr>
          <tr v-for="(mail, idx) in pendingEmails" :key="'pending-'+idx">
            <td>{{ mail.subject }}</td>
            <td>{{ mail.from }}</td>
            <td>{{ mail.daysWaiting }}</td>
          </tr>
        </table>
      </div>

      <!-- Resumen de Cuentas & Próximos Pasos (Ancho Completo) -->
      <div class="metric-card xl:col-span-2">
        <h2 class="section-title">Resumen de Cuentas & Próximos Pasos</h2>
        <p class="section-description">
          Lista de cuentas con una línea de resumen y un próximo paso sugerido.
        </p>
        <table>
          <tr>
            <th>Nombre de la Cuenta</th>
            <th>Responsable</th>
            <th>Resumen</th>
            <th>Próximo Paso</th>
          </tr>
          <tr v-for="(acc, idx) in accountSummary" :key="'acc-'+idx">
            <td>{{ acc.AccountName }}</td>
            <td>{{ acc.Owner }}</td>
            <td>{{ acc.Summary }}</td>
            <td>{{ acc.SuggestedNextStep }}</td>
          </tr>
        </table>
      </div>

    </div>
  </div>

  <script>
    const app = Vue.createApp({
      data() {
        return {
          hotTopics: [],
          emailDistribution: [],
          accountDistribution: [],
          handlingTimeTeam: [],
          handlingTimeAccount: [],
          activityVolume: [],
          emailResponseStats: [],
          pendingEmails: [],
          accountSummary: []
        };
      },
      methods: {
        async loadCSV() {
          const response = await fetch("report_data.csv");
          const text = await response.text();
          
          const rows = text.split("\n").map(row => row.split(","));
          const headers = rows.shift(); // Primera fila es la cabecera
  
          const parseData = (columns) => {
            return rows.map(row => {
              let obj = {};
              columns.forEach((col, index) => {
                obj[col] = row[index].trim();
              });
              return obj;
            });
          };
  
          this.hotTopics = parseData(["Topic", "Mentions"]);
          this.emailDistribution = parseData(["Category", "Count"]);
          this.accountDistribution = parseData(["Account", "Servicing", "Management"]);
          this.handlingTimeTeam = parseData(["User", "Hours"]);
          this.handlingTimeAccount = parseData(["Account", "Hours"]);
          this.activityVolume = parseData(["Company", "Activity"]);
          this.emailResponseStats = parseData(["Status", "Count"]);
          this.pendingEmails = parseData(["Subject", "Sender", "Days Waiting"]);
          this.accountSummary = parseData(["Account", "Owner", "Summary", "Next Step"]);
  
          this.renderCharts();
        },
        renderCharts() {
          new Chart(document.getElementById("servicingDistributionUserDonut"), {
            type: "doughnut",
            data: {
              labels: this.emailDistribution.map(d => d.Category),
              datasets: [{
                data: this.emailDistribution.map(d => Number(d.Count)),
                backgroundColor: ["#0379E8", "#6C778C"]
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false
            }
          });
  
          new Chart(document.getElementById("servicingDistributionAccountBar"), {
            type: "bar",
            data: {
              labels: this.accountDistribution.map(d => d.Account),
              datasets: [
                {
                  label: "Servicing",
                  data: this.accountDistribution.map(d => Number(d.Servicing)),
                  backgroundColor: "#0379E8"
                },
                {
                  label: "Management",
                  data: this.accountDistribution.map(d => Number(d.Management)),
                  backgroundColor: "#6C778C"
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true }
              }
            }
          });
        }
      },
      mounted() {
        this.loadCSV();
      }
    });
  
    app.mount("#app");
  </script>
  
</body>
</html>